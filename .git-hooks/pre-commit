#!/usr/bin/env bash
#
# ---------------------------
# .NET pre-commit hook
# ---------------------------
#
# To enable this hook, either copy it to the default location:
#   cp .git-hooks/pre-commit .git/hooks/pre-commit
# or set the hooks path in your git config:
#   git config core.hooksPath .git-hooks
#
# Optional:
#   Uncomment the <AUTO-FORMAT> block below to automatically fix and restage
#   formatting issues before committing.
#   (In that case, copying the hook to .git/hooks is recommended
#   to avoid committing local configuration.)
#

set -e  # stop on first error

echo "### pre-commit ###"

# Get staged C# files (that are added or modified)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=AM | grep '\.cs$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "    No staged C# files. Skipping format check."
  exit 0
fi

# ---------------------------
# AUTO-FORMAT
# ---------------------------
# echo "    Running formatter..."
# dotnet format --verbosity quiet --include $STAGED_FILES || true
# echo "    Files modified after formatting:"
# MODIFIED_FILED=$(git diff --name-only $STAGED_FILES || true)
# if [ -n "$MODIFIED_FILED" ]; then
#   echo "$MODIFIED_FILED" | sed 's/^/        - /'
#   echo "    Restaging modified files..."
#   git add $MODIFIED_FILED
# else
#   echo "        [None]"
# fi
# ---------------------------

echo "    Verifying code formatting..."
if ! dotnet format --verify-no-changes --verbosity quiet --include $STAGED_FILES; then
    echo "    ‚ùå  Code not formatted correctly."
    echo "        Run 'dotnet format' to fix formatting issues before committing."
    exit 1
fi

echo "    Formatting verified. Proceeding with commit."
